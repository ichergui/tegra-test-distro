From 8cbc97ebfafdc0a339c1d0514d30e6993865547a Mon Sep 17 00:00:00 2001
From: Ilies CHERGUI <ilies.chergui@gmail.com>
Date: Fri, 25 Dec 2020 22:42:48 +0000
Subject: [PATCH] t210: mender FIT image bootcmd support.

Signed-off-by: Ilies CHERGUI <ilies.chergui@gmail.com>
---
 include/configs/tegra210-common.h |  6 ++++--
 include/env_default.h             |  7 +++++--
 include/env_mender.h              | 20 ++++++++++++++++++++
 scripts/config_whitelist.txt      |  1 +
 4 files changed, 30 insertions(+), 4 deletions(-)

diff --git a/include/configs/tegra210-common.h b/include/configs/tegra210-common.h
index 35cead04de..153c367e7e 100644
--- a/include/configs/tegra210-common.h
+++ b/include/configs/tegra210-common.h
@@ -41,6 +41,8 @@
  *   for the FDT/DTB to be up to 1M, which is hopefully plenty.
  */
 #define CONFIG_LOADADDR 0x80080000
+/* FIT Image Load address */
+#define CONFIG_FITFDT_LOADADDR 0x90000000
 #define MEM_LAYOUT_ENV_SETTINGS \
 	"scriptaddr=0x90000000\0" \
 	"pxefile_addr_r=0x90100000\0" \
@@ -81,8 +83,8 @@
 		"/chosen/uuid:" \
 		"/chosen/linux,initrd-start:" \
 		"/chosen/linux,initrd-end:" \
-		"/psci/nvidia,system-lp0-disable:" \
-		"/serial-number\0"
+		"/serial-number\0" \
+	"fitfdt_loadaddr=" __stringify(CONFIG_FITFDT_LOADADDR) "\0"
 
 /* For USB EHCI controller */
 #define CONFIG_EHCI_IS_TDI
diff --git a/include/env_default.h b/include/env_default.h
index 6b27d9abd0..c14df35c36 100644
--- a/include/env_default.h
+++ b/include/env_default.h
@@ -34,8 +34,8 @@ const uchar default_environment[] = {
 #ifdef	CONFIG_USE_BOOTARGS
 	"bootargs="	CONFIG_BOOTARGS			"\0"
 #endif
-#ifdef	CONFIG_MENDER_BOOTCOMMAND
-	"bootcmd="	CONFIG_MENDER_BOOTCOMMAND	"\0"
+#ifdef	CONFIG_MENDER_FITFDT_BOOTCOMMAND
+	"bootcmd="	CONFIG_MENDER_FITFDT_BOOTCOMMAND	"\0"
 #endif
 #ifdef	CONFIG_RAMBOOTCOMMAND
 	"ramboot="	CONFIG_RAMBOOTCOMMAND		"\0"
@@ -85,6 +85,9 @@ const uchar default_environment[] = {
 #ifdef	CONFIG_LOADADDR
 	"loadaddr="	__stringify(CONFIG_LOADADDR)	"\0"
 #endif
+#ifdef CONFIG_FITFDT_LOADADDR
+	"fitfdt_loadaddr="     __stringify(CONFIG_FITFDT_LOADADDR)	"\0"
+#endif
 #ifdef	CONFIG_CLOCKS_IN_MHZ
 	"clocks_in_mhz=1\0"
 #endif
diff --git a/include/env_mender.h b/include/env_mender.h
index fbed122807..ff91cb9e39 100644
--- a/include/env_mender.h
+++ b/include/env_mender.h
@@ -154,6 +154,26 @@
     "sysboot ${devtype} ${devnum}:${distro_bootpart_hex} any ${scriptaddr} ${prefix}extlinux/extlinux.conf; " \
     "run mender_try_to_recover"
 
+#define CONFIG_MENDER_FITFDT_BOOTCOMMAND                                \
+    "run mender_setup; "                                                \
+    "setenv distro_bootpart ${mender_boot_part}; "                      \
+    "setenv distro_bootpart_hex ${mender_boot_part_hex}; "              \
+    "setenv devnum " __stringify(MENDER_UBOOT_STORAGE_DEVICE) "; "      \
+    "setenv devtype " __stringify(MENDER_UBOOT_STORAGE_INTERFACE) "; "  \
+    "setenv prefix /boot/; "                                            \
+    "setenv load_fit_image load ${devtype} ${devnum}:${distro_bootpart_hex} ${fitfdt_loadaddr} ${prefix}fitImage; "  \
+    "setenv extract_fit_dtb imxtract ${fitfdt_loadaddr} fdt ${fdt_addr_r}; " \
+    MENDER_BOOTARGS                                                     \
+    "setenv bootargs ${bootargs} rw rootwait; "                         \
+    "if test \"${systemd_machine_id}\" != \"\"; then "                  \
+    "setenv bootargs ${bootargs} systemd.machine_id=${systemd_machine_id}; " \
+    "fi; "                                                              \
+    "setenv bootargs ${cbootargs} ${bootargs}; "                        \
+    "run load_fit_image; "                                              \
+    "run extract_fit_dtb; "                                             \
+    "bootm ${fitfdt_loadaddr}:kernel $fitfdt_loadaddr}:ramdisk ${fdt_addr_r}; " \
+    "run mender_try_to_recover;"
+
 #endif /* !MENDER_AUTO_PROBING */
 
 #endif /* HEADER_ENV_MENDER_H */
diff --git a/scripts/config_whitelist.txt b/scripts/config_whitelist.txt
index 6908431d03..249eef0a1a 100644
--- a/scripts/config_whitelist.txt
+++ b/scripts/config_whitelist.txt
@@ -535,6 +535,7 @@ CONFIG_FEROCEON_88FR131
 CONFIG_FILE
 CONFIG_FIRMWARE_OFFSET
 CONFIG_FIRMWARE_SIZE
+CONFIG_FITFDT_LOADADDR
 CONFIG_FIXED_PHY
 CONFIG_FIXED_PHY_ADDR
 CONFIG_FIXED_SDHCI_ALIGNED_BUFFER
-- 
2.17.1

